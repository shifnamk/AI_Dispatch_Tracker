{% extends "base.html" %}

{% block title %}Camera Settings - Food Recognition System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-0">
                <i class="fas fa-cog text-primary"></i> 
                Camera Settings
            </h1>
            <p class="text-muted">Configure and manage camera connections for food recognition</p>
        </div>
    </div>

    <!-- Add New Camera -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-plus-circle"></i> Add New Camera
                    </h5>
                </div>
                <div class="card-body">
                    <form id="add-camera-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="camera-name" class="form-label">Camera Name *</label>
                                    <input type="text" class="form-control" id="camera-name" name="name" required 
                                           placeholder="e.g., Overhead Counter Camera">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="camera-type" class="form-label">Camera Type *</label>
                                    <select class="form-select" id="camera-type" name="camera_type" required>
                                        <option value="">Select camera type</option>
                                        <option value="webcam">Built-in/USB Webcam</option>
                                        <option value="ip">IP Camera (HTTP)</option>
                                        <option value="rtsp">IP Camera (RTSP)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="camera-url" class="form-label">Camera URL/Index *</label>
                                    <input type="text" class="form-control" id="camera-url" name="url" required>
                                    <div class="form-text" id="url-help">
                                        Enter camera URL or device index
                                    </div>
                                </div>
                                
                                <div class="row" id="auth-fields" style="display: none;">
                                    <div class="col-6">
                                        <div class="mb-3">
                                            <label for="camera-username" class="form-label">Username</label>
                                            <input type="text" class="form-control" id="camera-username" name="username">
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="mb-3">
                                            <label for="camera-password" class="form-label">Password</label>
                                            <input type="password" class="form-control" id="camera-password" name="password">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="make-active" name="make_active">
                                    <label class="form-check-label" for="make-active">
                                        Set as active camera (deactivates other cameras)
                                    </label>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Add Camera
                                </button>
                                <button type="reset" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Clear Form
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Examples -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle"></i> Camera URL Examples
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="text-primary">Built-in/USB Webcam</h6>
                            <code>0</code> (first camera)<br>
                            <code>1</code> (second camera)<br>
                            <code>2</code> (third camera)
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-primary">IP Camera (RTSP)</h6>
                            <code>rtsp://192.168.1.100:554/stream1</code><br>
                            <code>rtsp://192.168.1.100:554/cam/realmonitor</code><br>
                            <small class="text-muted">Username/password entered separately</small>
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-primary">IP Camera (HTTP)</h6>
                            <code>http://192.168.1.100:8080/video</code><br>
                            <code>http://192.168.1.100/mjpeg</code><br>
                            <small class="text-muted">For HTTP streaming cameras</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Existing Cameras -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-video"></i> Configured Cameras
                    </h5>
                    <span class="badge bg-primary">{{ cameras|length }} cameras</span>
                </div>
                <div class="card-body">
                    {% if cameras %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>URL</th>
                                        <th>Status</th>
                                        <th>Last Tested</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for camera in cameras %}
                                    <tr class="{% if camera.is_active %}table-success{% endif %}">
                                        <td>
                                            <strong>{{ camera.name }}</strong>
                                            {% if camera.is_active %}
                                                <span class="badge bg-success ms-2">Active</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ camera.camera_type.upper() }}</span>
                                        </td>
                                        <td>
                                            <code class="small">{{ camera.url[:30] }}{% if camera.url|length > 30 %}...{% endif %}</code>
                                        </td>
                                        <td>
                                            {% if camera.connection_status == 'connected' %}
                                                <span class="badge bg-success">Connected</span>
                                            {% elif camera.connection_status == 'failed' %}
                                                <span class="badge bg-danger">Failed</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Untested</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if camera.last_tested %}
                                                <small>
                                                    {{ camera.last_tested if camera.last_tested is string else camera.last_tested.strftime('%Y-%m-%d %H:%M') }}
                                                </small>
                                            {% else %}
                                                <small class="text-muted">Never</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-outline-primary test-camera" data-camera-id="{{ camera.id }}">
                                                    <i class="fas fa-play"></i> Test
                                                </button>
                                                {% if not camera.is_active %}
                                                <button class="btn btn-outline-success activate-camera" data-camera-id="{{ camera.id }}">
                                                    <i class="fas fa-check"></i> Activate
                                                </button>
                                                {% endif %}
                                                <button class="btn btn-outline-danger delete-camera" data-camera-id="{{ camera.id }}">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-video fa-4x text-muted mb-3"></i>
                            <h4 class="text-muted">No Cameras Configured</h4>
                            <p class="text-muted">Add your first camera to start food recognition</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Camera Modal -->
<div class="modal fade" id="testCameraModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Camera Test Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="test-result"></div>
                <div id="camera-preview" class="text-center mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 id="loading-message">Testing camera connection...</h5>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Update form fields based on camera type selection
    $('#camera-type').change(function() {
        const cameraType = $(this).val();
        const urlField = $('#camera-url');
        const urlHelp = $('#url-help');
        const authFields = $('#auth-fields');
        
        if (cameraType === 'webcam') {
            urlField.attr('placeholder', '0');
            urlHelp.text('Enter device index (0 for first camera, 1 for second, etc.)');
            authFields.hide();
        } else if (cameraType === 'rtsp') {
            urlField.attr('placeholder', 'rtsp://192.168.1.100:554/stream1');
            urlHelp.text('Enter RTSP URL (without username/password)');
            authFields.show();
        } else if (cameraType === 'ip') {
            urlField.attr('placeholder', 'http://192.168.1.100:8080/video');
            urlHelp.text('Enter HTTP streaming URL');
            authFields.show();
        } else {
            urlField.attr('placeholder', '');
            urlHelp.text('Enter camera URL or device index');
            authFields.hide();
        }
    });
    
    // Add camera form submission
    $('#add-camera-form').submit(function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        // Validation
        if (!$('#camera-name').val().trim()) {
            alert('Please enter a camera name');
            return;
        }
        
        if (!$('#camera-type').val()) {
            alert('Please select a camera type');
            return;
        }
        
        if (!$('#camera-url').val().trim()) {
            alert('Please enter a camera URL or index');
            return;
        }
        
        // Show loading
        $('#loading-message').text('Adding camera...');
        $('#loadingModal').modal('show');
        
        // Submit form
        $.ajax({
            url: '/add_camera',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                $('#loadingModal').modal('hide');
                
                if (response.success) {
                    alert('Camera added successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + (response.error || 'Unknown error'));
                }
            },
            error: function(xhr) {
                $('#loadingModal').modal('hide');
                
                let errorMessage = 'Failed to add camera';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage += ': ' + xhr.responseJSON.error;
                }
                alert(errorMessage);
            }
        });
    });
    
    // Test camera button
    $('.test-camera').click(function() {
        const cameraId = $(this).data('camera-id');
        
        $('#loading-message').text('Testing camera connection...');
        $('#loadingModal').modal('show');
        
        $.post(`/test_camera/${cameraId}`, function(response) {
            $('#loadingModal').modal('hide');
            
            if (response.success) {
                $('#test-result').html(`
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> ${response.message}
                    </div>
                `);
                
                if (response.preview) {
                    $('#camera-preview').html(`
                        <img src="${response.preview}" class="img-fluid rounded" style="max-height: 300px;">
                        <p class="text-muted mt-2">Live camera preview</p>
                    `);
                }
                
                $('#testCameraModal').modal('show');
                
                // Refresh page to update status
                setTimeout(() => location.reload(), 2000);
            } else {
                alert('Camera test failed: ' + (response.error || 'Unknown error'));
            }
        }).fail(function(xhr) {
            $('#loadingModal').modal('hide');
            
            let errorMessage = 'Camera test failed';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMessage += ': ' + xhr.responseJSON.error;
            }
            alert(errorMessage);
        });
    });
    
    // Activate camera button
    $('.activate-camera').click(function() {
        const cameraId = $(this).data('camera-id');
        
        if (confirm('Activate this camera? This will deactivate the current active camera.')) {
            $.post(`/activate_camera/${cameraId}`, function(response) {
                if (response.success) {
                    alert(response.message);
                    location.reload();
                } else {
                    alert('Error: ' + (response.error || 'Unknown error'));
                }
            }).fail(function(xhr) {
                let errorMessage = 'Failed to activate camera';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage += ': ' + xhr.responseJSON.error;
                }
                alert(errorMessage);
            });
        }
    });
    
    // Delete camera button
    $('.delete-camera').click(function() {
        const cameraId = $(this).data('camera-id');
        
        if (confirm('Are you sure you want to delete this camera? This action cannot be undone.')) {
            $.post(`/delete_camera/${cameraId}`, function(response) {
                if (response.success) {
                    alert(response.message);
                    location.reload();
                } else {
                    alert('Error: ' + (response.error || 'Unknown error'));
                }
            }).fail(function(xhr) {
                let errorMessage = 'Failed to delete camera';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage += ': ' + xhr.responseJSON.error;
                }
                alert(errorMessage);
            });
        }
    });
    
    // Form reset
    $('button[type="reset"]').click(function() {
        $('#auth-fields').hide();
        $('#url-help').text('Enter camera URL or device index');
    });
});
</script>
{% endblock %}
